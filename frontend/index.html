<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body {
            font-family: 'Sarabun', 'Arial', sans-serif;
        }

        /* Hero Section Background (‡πÉ‡∏ä‡πâ Placeholder ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) */
        .hero-section {
            background-image: url('https://placehold.co/1200x400/17a2b8/ffffff?text=Saving+for+Vacation');
            background-size: cover; 
            background-position: center; 
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR Code Placeholder */
        .qr-placeholder {
            filter: grayscale(80%);
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-700">

    <!-- Hero Section (‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß) -->
    <header class="hero-section text-white text-center py-20 md:py-32 shadow-2xl">
        <div class="bg-black/20 p-6 rounded-xl max-w-5xl mx-auto backdrop-blur-sm">
            <h1 class="text-4xl md:text-5xl font-bold mb-3 drop-shadow-lg">üåä **Saving Tides** | ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏±‡∏ö </h1>
            <p class="text-xl mb-4">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <div class="inline-block bg-white/95 p-6 md:p-8 rounded-2xl shadow-xl mt-4">
                <h2 id="totalAmount" class="text-5xl md:text-6xl font-extrabold text-yellow-500 tracking-wider">0.00 ‡∏ö‡∏≤‡∏ó</h2>
            </div>
            <!-- ‡πÅ‡∏™‡∏î‡∏á User ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Firestore -->
            <p id="userIdDisplay" class="text-xs mt-3 text-gray-100"></p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-10">

        <!-- Dashboard Cards (‡∏¢‡∏≠‡∏î‡∏≠‡∏≠‡∏°‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•) -->
        <section class="bg-white p-6 md:p-10 rounded-xl shadow-lg mb-10">
            <h2 class="text-3xl font-bold text-cyan-600 text-center mb-8">üê≥ ‡∏¢‡∏≠‡∏î‡∏≠‡∏≠‡∏°‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                <!-- Card Template -->
                <div class="bg-blue-50 p-5 rounded-xl shadow-md text-center border-t-4 border-blue-400 transition transform hover:shadow-xl hover:scale-[1.02]">
                    <h3 class="text-xl font-semibold text-blue-800">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</h3>
                    <p id="amount‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô" class="text-3xl font-extrabold text-blue-600 mt-2">0.00 ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div class="bg-blue-50 p-5 rounded-xl shadow-md text-center border-t-4 border-blue-400 transition transform hover:shadow-xl hover:scale-[1.02]">
                    <h3 class="text-xl font-semibold text-blue-800">‡∏£‡∏ñ‡πÄ‡∏ö‡∏ô‡∏ã‡πå</h3>
                    <p id="amount‡∏£‡∏ñ‡πÄ‡∏ö‡∏ô‡∏ã‡πå" class="text-3xl font-extrabold text-blue-600 mt-2">0.00 ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div class="bg-blue-50 p-5 rounded-xl shadow-md text-center border-t-4 border-blue-400 transition transform hover:shadow-xl hover:scale-[1.02]">
                    <h3 class="text-xl font-semibold text-blue-800">‡πÅ‡∏û‡∏£‡∏ß‡∏≤</h3>
                    <p id="amount‡πÅ‡∏û‡∏£‡∏ß‡∏≤" class="text-3xl font-extrabold text-blue-600 mt-2">0.00 ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div class="bg-blue-50 p-5 rounded-xl shadow-md text-center border-t-4 border-blue-400 transition transform hover:shadow-xl hover:scale-[1.02]">
                    <h3 class="text-xl font-semibold text-blue-800">‡∏°‡∏¥‡πâ‡∏ß</h3>
                    <p id="amount‡∏°‡∏¥‡πâ‡∏ß" class="text-3xl font-extrabold text-blue-600 mt-2">0.00 ‡∏ö‡∏≤‡∏ó</p>
                </div>
            </div>
        </section>

        <!-- Deposit Form (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà) -->
        <section class="bg-white p-6 md:p-10 rounded-xl shadow-lg mb-10">
            <h2 class="text-3xl font-bold text-cyan-600 text-center mb-8">üèùÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</h2>
            <div class="max-w-xl mx-auto bg-gray-50 p-6 rounded-lg shadow-inner">
                <form id="savingForm">
                    
                    <label for="depositorName" class="block mt-4 text-lg font-semibold text-blue-800">1. ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏°:</label>
                    <select id="depositorName" name="depositorName" required class="mt-2 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>
                        <option value="‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</option>
                        <option value="‡∏£‡∏ñ‡πÄ‡∏ö‡∏ô‡∏ã‡πå">‡∏£‡∏ñ‡πÄ‡∏ö‡∏ô‡∏ã‡πå</option>
                        <option value="‡πÅ‡∏û‡∏£‡∏ß‡∏≤">‡πÅ‡∏û‡∏£‡∏ß‡∏≤</option>
                        <option value="‡∏°‡∏¥‡πâ‡∏ß">‡∏°‡∏¥‡πâ‡∏ß</option>
                    </select>

                    <label for="depositDate" class="block mt-4 text-lg font-semibold text-blue-800">2. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏°:</label>
                    <input type="date" id="depositDate" name="depositDate" required class="mt-2 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">

                    <label for="depositAmount" class="block mt-4 text-lg font-semibold text-blue-800">3. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</label>
                    <input type="number" id="depositAmount" name="depositAmount" min="1" step="0.01" required class="mt-2 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 500.00">

                    <h3 class="text-xl font-semibold text-blue-800 mt-6">4. ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="text-center my-6 p-6 border-2 border-dashed border-cyan-400 rounded-xl bg-cyan-50">
                        <!-- QR Code Placeholder ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ -->
                        <img src="https://placehold.co/200x200/17a2b8/ffffff?text=QR+Code" alt="QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="qr-placeholder w-48 h-48 block mx-auto rounded-md">
                        <p class="mt-3 text-cyan-700 font-medium">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ | ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏°‡∏ì‡∏ë‡∏¥‡∏ï‡∏≤</p>
                    </div>

                    <!-- **‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö Firestore** -->

                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white p-4 rounded-xl text-xl font-bold mt-8 shadow-lg transition transform hover:bg-blue-700 active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-300">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°
                    </button>
                    <div id="message" class="message-box mt-4 hidden"></div>
                </form>
            </div>
        </section>

        <!-- History Table (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) -->
        <section class="bg-white p-6 md:p-10 rounded-xl shadow-lg mb-10">
            <h2 class="text-3xl font-bold text-cyan-600 text-center mb-8">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="overflow-x-auto shadow-xl rounded-xl">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider rounded-tl-xl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏°</th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider rounded-tr-xl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="text-center mt-6">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ Backend ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å -->
                <p class="text-gray-500">
                    *‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Backend Server ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                </p>
            </div>
        </section>
    </main>
    
    <footer class="text-center py-6 bg-gray-800 text-gray-400 mt-10">
        <p>&copy; 2025 Saving Tides Project</p>
    </footer>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
        const MEMBERS = ["‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô", "‡∏£‡∏ñ‡πÄ‡∏ö‡∏ô‡∏ã‡πå", "‡πÅ‡∏û‡∏£‡∏ß‡∏≤", "‡∏°‡∏¥‡πâ‡∏ß"];

        const savingForm = document.getElementById('savingForm');
        const transactionTableBody = document.getElementById('transactionTableBody');
        const totalAmountElement = document.getElementById('totalAmount');
        const messageBox = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // -------------------------------------------------------------------
        // 1. Firebase Initialization and Auth
        // -------------------------------------------------------------------

        setLogLevel('Debug'); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Debug log

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Custom token sign-in failed, falling back to anonymous:", e);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showMessage('‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Firebase) ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                console.log("Firebase Auth Ready. User ID:", userId);
                setupRealtimeListener(); // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Auth ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            } else {
                // User is signed out, but anonymous sign-in usually keeps a user session.
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î Collection Path
        function getCollectionPath() {
            if (!userId) {
                throw new Error("User ID is not available for Firestore operations.");
            }
            // Private data storage path: /artifacts/{appId}/users/{userId}/savings
            return `artifacts/${appId}/users/${userId}/savings`;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÅ‡∏ó‡∏ô alert)
        function showMessage(msg, type = 'success') {
            messageBox.textContent = msg;
            messageBox.classList.remove('bg-red-100', 'text-red-700', 'border-red-400', 'bg-green-100', 'text-green-700', 'border-green-400');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-400', 'p-3', 'rounded-lg', 'font-medium', 'block');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-400', 'p-3', 'rounded-lg', 'font-medium', 'block');
            }
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≤‡∏ó
        function formatCurrency(amount) {
            return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ‡∏ö‡∏≤‡∏ó';
        }

        // -------------------------------------------------------------------
        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Real-time Listener)
        // -------------------------------------------------------------------

        function setupRealtimeListener() {
            try {
                const savingsCollectionRef = collection(db, getCollectionPath());
                
                // Query: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° createdAt ‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                const q = query(savingsCollectionRef, orderBy('createdAt', 'desc'));

                // onSnapshot: ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
                onSnapshot(q, (querySnapshot) => {
                    const transactions = [];
                    querySnapshot.forEach((doc) => {
                        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏° doc.id ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
                        transactions.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log(`Received ${transactions.length} transactions from Firestore.`);
                    
                    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    processAndDisplayData(transactions);
                }, (error) => {
                    console.error('Error listening to Firestore:', error);
                    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå', 'error');
                });

            } catch (error) {
                console.error('Error setting up listener:', error);
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function processAndDisplayData(transactions) {
            // 2.1 ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const totalSavings = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            totalAmountElement.textContent = formatCurrency(totalSavings);

            // 2.2 ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏≠‡∏≠‡∏°‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
            const memberTotals = MEMBERS.reduce((acc, member) => {
                acc[member] = 0;
                return acc;
            }, {});

            transactions.forEach(t => {
                // ‡πÉ‡∏ä‡πâ depositorName ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô DB
                const key = t.depositorName; 
                if (memberTotals.hasOwnProperty(key)) {
                    memberTotals[key] += t.amount;
                }
            });

            MEMBERS.forEach(member => {
                const el = document.getElementById(`amount${member}`);
                if (el) {
                    el.textContent = formatCurrency(memberTotals[member] || 0);
                }
            });

            // 2.3 ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°
            displayTransactionHistory(transactions);
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function displayTransactionHistory(transactions) {
            transactionTableBody.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

            transactions.forEach((t, index) => {
                const row = transactionTableBody.insertRow();
                
                // ‡πÉ‡∏ä‡πâ Tailwind ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ñ‡∏ß‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ
                if (index % 2 === 1) {
                    row.classList.add('bg-gray-50');
                } else {
                    row.classList.add('bg-white');
                }
                row.classList.add('hover:bg-blue-50', 'transition-colors', 'duration-150');

                // ‡πÅ‡∏õ‡∏•‡∏á createdAt ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ createdAt ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ slipUrl/depositDate ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
                const dateToDisplay = t.createdAt || t.depositDate || new Date().toISOString();
                const formattedDate = new Date(dateToDisplay).toLocaleDateString('th-TH', {
                    day: '2-digit', month: 'short', year: 'numeric'
                });

                row.insertCell().textContent = formattedDate;
                row.insertCell().textContent = t.depositorName;
                
                const amountCell = row.insertCell();
                amountCell.classList.add('font-semibold', 'text-green-600');
                amountCell.textContent = formatCurrency(t.amount || 0).replace(' ‡∏ö‡∏≤‡∏ó', ''); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            });
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            if (transactions.length === 0) {
                const row = transactionTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.classList.add('text-center', 'py-4', 'text-gray-500', 'italic');
                cell.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
            }
        }

        // -------------------------------------------------------------------
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà (Submit Form) - ‡πÉ‡∏ä‡πâ Firestore
        // -------------------------------------------------------------------

        savingForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!userId) {
                showMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'error');
                return;
            }
            
            const depositorName = document.getElementById('depositorName').value;
            const depositDate = document.getElementById('depositDate').value;
            const depositAmount = document.getElementById('depositAmount').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
            const amount = parseFloat(depositAmount);
            if (isNaN(amount) || amount <= 0) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            submitBtn.classList.add('bg-gray-400');
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            try {
                const newTransaction = {
                    depositorName: depositorName,
                    depositDate: depositDate, // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
                    amount: amount,
                    createdAt: new Date().toISOString() // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                };

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firestore
                const docRef = await addDoc(collection(db, getCollectionPath()), newTransaction);
                
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                savingForm.reset(); // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('depositDate').value = today;

                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchSavingsData() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ onSnapshot ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

            } catch (error) {
                console.error('Error submitting to Firestore:', error);
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°';
                submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.remove('bg-gray-400');
            }
        });

        // -------------------------------------------------------------------
        // 4. Initial Load
        // -------------------------------------------------------------------

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('depositDate').value = today;
            // setupRealtimeListener ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô onAuthStateChanged
        });

    </script>
</body>
</html>